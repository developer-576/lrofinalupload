<?php
/**************************************************
 * modules/lrofileupload/admin/view_uploads.php
 **************************************************/
declare(strict_types=1);

ini_set('display_errors','1');
ini_set('display_startup_errors','1');
error_reporting(E_ALL);

/* ---------- Single bootstrap (same as viewer) ---------- */
require_once __DIR__.'/_bootstrap.php';

/* ---------- Session & Admin auth ---------- */
if (session_status() === PHP_SESSION_NONE) session_start();
if (function_exists('lro_require_admin')) {
  lro_require_admin(false);
} elseif (function_exists('require_admin_login')) {
  require_admin_login(false);
} else {
  if (empty($_SESSION['admin_id'])) { http_response_code(403); exit('Forbidden (admins only)'); }
}
if (function_exists('require_cap')) require_cap('can_review_uploads');

if (function_exists('admin_log')) {
  admin_log('view:lrofileupload_uploads', [
    'admin_id' => $_SESSION['admin_id'] ?? null,
    'ip'       => $_SERVER['REMOTE_ADDR'] ?? null,
    'ua'       => $_SERVER['HTTP_USER_AGENT'] ?? null,
  ]);
}

/* ---------- Helpers ---------- */
function h($s){ return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }

/* ---------- DB & constants ---------- */
$db   = Db::getInstance();
$tblU = _DB_PREFIX_.'lrofileupload_uploads';
$tblC = _DB_PREFIX_.'customer';

$base = rtrim(Tools::getShopDomainSsl(true), '/') . rtrim(__PS_BASE_URI__ ?? '/', '/');

if (empty($_SESSION['csrf_token'])) $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
$CSRF = $_SESSION['csrf_token'];

/* ---------- Filters & pagination ---------- */
$limit  = max(1, (int)($_GET['limit'] ?? 25));
$page   = max(1, (int)($_GET['page'] ?? 1));
$offset = ($page - 1) * $limit;

$status    = trim((string)($_GET['status'] ?? ''));   // '', pending/approved/rejected
$customerQ = trim((string)($_GET['customer'] ?? '')); // id or name/email search
$dateFrom  = trim((string)($_GET['date_from'] ?? ''));
$dateTo    = trim((string)($_GET['date_to'] ?? ''));

$conds = [];
if ($status !== '')              $conds[] = "u.status = '".pSQL($status)."'";
if ($customerQ !== '') {
  if (ctype_digit($customerQ))   $conds[] = "u.id_customer = ".(int)$customerQ;
  else {
    $like = '%'.pSQL($customerQ).'%';
    $conds[] = "(c.firstname LIKE '$like' OR c.lastname LIKE '$like' OR c.email LIKE '$like')";
  }
}
if ($dateFrom !== '')            $conds[] = "u.uploaded_at >= '".pSQL($dateFrom)." 00:00:00'";
if ($dateTo   !== '')            $conds[] = "u.uploaded_at <= '".pSQL($dateTo)." 23:59:59'";
$whereSql = $conds ? (' WHERE '.implode(' AND ', $conds)) : '';

/* ---------- Count ---------- */
$sqlCount = "
  SELECT COUNT(*)
  FROM `$tblU` u
  LEFT JOIN `$tblC` c ON c.id_customer = u.id_customer
  $whereSql
";
$totalRows = (int)$db->getValue($sqlCount);

/* ---------- List ---------- */
$sqlList = "
  SELECT 
    u.id_upload AS file_id,
    u.id_customer AS customer_id,
    u.file_name AS filename,
    u.original_name,
    u.status,
    u.id_group, u.id_requirement, u.requirement_name,
    u.uploaded_at AS created_at,
    u.approved_by, u.approved_at, u.rejected_by, u.rejected_at,
    u.rejection_reason, u.rejection_notes,
    IFNULL(c.firstname,'') AS firstname, IFNULL(c.lastname,'') AS lastname, IFNULL(c.email,'') AS email
  FROM `$tblU` u
  LEFT JOIN `$tblC` c ON c.id_customer = u.id_customer
  $whereSql
  ORDER BY u.uploaded_at DESC
  LIMIT ".(int)$limit." OFFSET ".(int)$offset;
";
$rows = $db->executeS($sqlList);
$totalPages = max(1, (int)ceil($totalRows / $limit));
?>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Uploaded Files</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf" content="<?= h($CSRF) ?>">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    .badge-status{text-transform:capitalize}.row-approved{background:#e8fff0}.row-rejected{background:#fff0f0}
    .table-fixed{table-layout:fixed}.word-break{word-break:break-all}
  </style>
</head>
<body class="container py-4">
<?php if (file_exists(__DIR__.'/nav.php')) include __DIR__.'/nav.php'; ?>

<h1 class="mb-3">Uploaded Files</h1>

<form method="get" class="row g-2 align-items-end mb-4">
  <div class="col-md-2">
    <label class="form-label">Status</label>
    <select name="status" class="form-select">
      <?php foreach(['','pending','approved','rejected'] as $opt): ?>
        <option value="<?=h($opt)?>" <?=$status===$opt?'selected':''?>><?=h($opt===''?'Any':ucfirst($opt))?></option>
      <?php endforeach; ?>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Customer (name/email/ID)</label>
    <input type="text" name="customer" value="<?=h($customerQ)?>" class="form-control" placeholder="Jane / 123">
  </div>
  <div class="col-md-2">
    <label class="form-label">From</label>
    <input type="date" name="date_from" value="<?=h($dateFrom)?>" class="form-control">
  </div>
  <div class="col-md-2">
    <label class="form-label">To</label>
    <input type="date" name="date_to" value="<?=h($dateTo)?>" class="form-control">
  </div>
  <div class="col-md-1">
    <label class="form-label">Per page</label>
    <input type="number" name="limit" value="<?=h((string)$limit)?>" min="1" max="200" class="form-control">
  </div>
  <div class="col-md-2 d-grid">
    <button class="btn btn-primary">Filter</button>
  </div>
</form>

<div class="d-flex justify-content-between align-items-center mb-2">
  <div><strong>Total:</strong> <?= (int)$totalRows ?> rows</div>
  <nav>
    <ul class="pagination pagination-sm mb-0">
      <?php
      $build=function($p)use($status,$customerQ,$dateFrom,$dateTo,$limit){
        return '?'.http_build_query(['status'=>$status,'customer'=>$customerQ,'date_from'=>$dateFrom,'date_to'=>$dateTo,'limit'=>$limit,'page'=>$p]);
      };
      $prev=max(1,$page-1); $next=min($totalPages,$page+1);
      ?>
      <li class="page-item <?=$page<=1?'disabled':''?>"><a class="page-link" href="<?=h($build($prev))?>">&laquo;</a></li>
      <li class="page-item disabled"><span class="page-link"><?= (int)$page ?> / <?= (int)$totalPages ?></span></li>
      <li class="page-item <?=$page>=$totalPages?'disabled':''?>"><a class="page-link" href="<?=h($build($next))?>">&raquo;</a></li>
    </ul>
  </nav>
</div>

<table class="table table-striped table-hover table-fixed align-middle">
  <thead class="table-light">
    <tr>
      <th style="width:80px;">ID</th>
      <th>Customer</th>
      <th>File</th>
      <th style="width:130px;">Status</th>
      <th style="width:140px;">Uploaded</th>
      <th style="width:220px;">Actions</th>
    </tr>
  </thead>
  <tbody>
  <?php foreach($rows as $r):
    $rowClass = $r['status']==='approved'?'row-approved':($r['status']==='rejected'?'row-rejected':'');
    $customer = trim($r['firstname'].' '.$r['lastname']) ?: ('#'.$r['customer_id']);
    $serveUrl = $base . '/modules/lrofileupload/admin/serve_file.php?id_upload='.(int)$r['file_id'].'&inline=1';
  ?>
    <tr id="row-<?= (int)$r['file_id'] ?>" class="<?=h($rowClass)?>">
      <td><?= (int)$r['file_id'] ?></td>
      <td>
        <div><strong><?= h($customer) ?></strong></div>
        <div class="text-muted small"><?= h($r['email']) ?></div>
      </td>
      <td class="word-break">
        <a href="<?= h($serveUrl) ?>" target="_blank" rel="noopener"><?= h($r['filename']) ?></a>
        <div class="text-muted small">Group: <?= h((string)$r['id_group']) ?> | Req: <?= h((string)$r['requirement_name']) ?></div>
      </td>
      <td><span class="badge bg-secondary badge-status"><?= h($r['status']) ?></span></td>
      <td><?= h($r['created_at']) ?></td>
      <td>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-success js-approve" data-id="<?= (int)$r['file_id'] ?>">Approve</button>
          <button type="button" class="btn btn-sm btn-outline-danger js-reject" data-id="<?= (int)$r['file_id'] ?>">Reject</button>
          <a class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener" href="<?= h($serveUrl) ?>">Preview</a>
        </div>
      </td>
    </tr>
  <?php endforeach; ?>
  </tbody>
</table>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="rejectForm">
      <div class="modal-header">
        <h5 class="modal-title">Reject file</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="file_id" id="reject_file_id" value="">
        <input type="hidden" name="csrf_token" value="<?= h($CSRF) ?>">
        <div class="mb-3">
          <label class="form-label">Reason (optional free text)</label>
          <textarea class="form-control" name="reason_text" rows="3" placeholder="Optional note for the customer"></textarea>
        </div>
        <div class="alert alert-warning small mb-0">Status will be set to <strong>rejected</strong>.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger">Confirm Reject</button>
      </div>
    </form>
  </div>
</div>

<script src="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const csrf = <?= json_encode($CSRF) ?>;

  document.querySelectorAll('.js-approve').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.dataset.id; btn.disabled = true;
      try{
        const res = await fetch('approve_file.php',{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body:new URLSearchParams({file_id:id, csrf_token:csrf})
        });
        const data = await res.json();
        if(!data.ok) throw new Error(data.error||'Approve failed');
        markRow(id,'approved');
      }catch(e){ alert(e.message); }finally{ btn.disabled=false; }
    });
  });

  const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
  document.querySelectorAll('.js-reject').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.getElementById('reject_file_id').value = btn.dataset.id;
      document.querySelector('#rejectForm textarea[name="reason_text"]').value = '';
      rejectModal.show();
    });
  });

  document.getElementById('rejectForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    try{
      const res = await fetch('reject_file.php',{ method:'POST', body:new URLSearchParams(fd) });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error||'Reject failed');
      rejectModal.hide();
      markRow(fd.get('file_id'),'rejected');
    }catch(err){ alert(err.message); }
  });

  function markRow(id,status){
    const row = document.getElementById('row-'+id);
    if(!row) return;
    row.classList.remove('row-approved','row-rejected');
    const badge = row.querySelector('.badge-status');
    if(status==='approved'){ row.classList.add('row-approved'); if(badge) badge.textContent='approved'; }
    if(status==='rejected'){ row.classList.add('row-rejected'); if(badge) badge.textContent='rejected'; }
  }
})();
</script>
</body>
</html>
